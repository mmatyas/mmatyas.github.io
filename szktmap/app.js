!function(){"use strict";function t(t,n,r){var e=new DataView(t),i=0;function o(t,n){return i+=t,n}function u(n){return o(n,new Uint8Array(t,i,n))}function c(){return o(1,e.getUint8(i))}function s(){return o(2,e.getUint16(i))}function a(){return o(4,e.getUint32(i))}function f(){return 255===e.getUint8(i)&&(i+=1,!0)}function h(t){if(t<24)return t;if(24===t)return c();if(25===t)return s();if(26===t)return a();if(27===t)return 4294967296*a()+a();if(31===t)return-1;throw"Invalid length encoding"}function w(t){var n=c();if(255===n)return-1;var r=h(31&n);if(r<0||n>>5!==t)throw"Invalid indefinite length element";return r}function l(t,n){for(var r=0;r<n;++r){var e=c();128&e&&(e<224?(e=(31&e)<<6|63&c(),n-=1):e<240?(e=(15&e)<<12|(63&c())<<6|63&c(),n-=2):(e=(15&e)<<18|(63&c())<<12|(63&c())<<6|63&c(),n-=3)),e<65536?t.push(e):(e-=65536,t.push(55296|e>>10),t.push(56320|1023&e))}}"function"!=typeof n&&(n=function(t){return t}),"function"!=typeof r&&(r=function(){});var d=function t(){var a,d,p=c(),v=p>>5,g=31&p;if(7===v)switch(g){case 25:return function(){var t=new ArrayBuffer(4),n=new DataView(t),r=s(),e=32768&r,i=31744&r,o=1023&r;if(31744===i)i=261120;else if(0!==i)i+=114688;else if(0!==o)return(e?-1:1)*o*5.960464477539063e-8;return n.setUint32(0,e<<16|i<<13|o<<13),n.getFloat32(0)}();case 26:return o(4,e.getFloat32(i));case 27:return o(8,e.getFloat64(i))}if((d=h(g))<0&&(v<2||6<v))throw"Invalid length";switch(v){case 0:return d;case 1:return-1-d;case 2:if(d<0){for(var m=[],y=0;(d=w(v))>=0;)y+=d,m.push(u(d));var L=new Uint8Array(y),_=0;for(a=0;a<m.length;++a)L.set(m[a],_),_+=m[a].length;return L}return u(d);case 3:var M=[];if(d<0)for(;(d=w(v))>=0;)l(M,d);else l(M,d);return String.fromCharCode.apply(null,M);case 4:var b;if(d<0)for(b=[];!f();)b.push(t());else for(b=new Array(d),a=0;a<d;++a)b[a]=t();return b;case 5:var k={};for(a=0;a<d||d<0&&!f();++a){k[t()]=t()}return k;case 6:return n(t(),d);case 7:switch(d){case 20:return!1;case 21:return!0;case 22:return null;case 23:return;default:return r(d)}}}();if(i!==t.byteLength)throw"Remaining bytes";return d}function n(){const t=new Date;window.NOW_MS=60*(60*t.getHours()+t.getMinutes())+t.getSeconds()+.001*t.getMilliseconds(),window.requestAnimationFrame(n)}function r(t,n,e,i){(function(t,n){return n.map(n=>n.find(n=>n.start_t<=t&&t<=n.end_t)).filter(t=>t)})(window.NOW_MS,n).filter(n=>!t.has(n.trip_id)).forEach(n=>{const r=function(t,n,r){const e=t.route_id,i=t.shape_id.toString(),o=r.routes.get(e),u=r.shapes.get(i),c=r.o.get(i),s=document.createElement("div");s.innerText=o.short_name,s.style.backgroundColor=o.route_color,s.style.color=o.text_color,s.classList.add("grow");const a=L.divIcon({html:s,className:"trip-icon"});return L.tripMarker(t.start_t,t.end_t,u,c,{icon:a}).bindPopup(`<b>${o.short_name}</b><br>${t.headsign}`).addTo(n)}(n,e,i);t.set(n.trip_id,r)}),setTimeout(r,1e3,t,n,e,i)}function e(t){return"#"+("000000"+t.toString(16)).slice(-6)}async function i(){const n=await fetch("data.cbor"),r=t(await n.arrayBuffer());r.routes=function(t){const n=t.i.map((n,r)=>[n,{route_color:e(t.r[r]),text_color:e(t.t[r]),long_name:t.l[r],short_name:t.s[r]}]);return new Map(n)}(r.routes),r.trips=function(t){const n=t.i.map((n,r)=>[n,{route_id:t.r[r],flags:t.f[r],shape_id:t.s[r],headsign:t.h[r],wheelch:t.w[r],start_t:t.a[r],end_t:t.z[r]}]);return new Map(n)}(r.trips),r.shapes=new Map(Object.entries(r.shapes));const i=1<<(new Date).getDay();for(const[t,n]of r.trips)0==(n.flags&i)?r.trips.delete(t):n.trip_id=t;return r}L.TripMarker=L.Marker.extend({initialize:function(t,n,r,e,i){this.u=t,this.p=n,this.v=n-t,this.g=r,this.m=e,this.L=e[e.length-1],this._=L.Util.requestAnimFrame(t=>this.M(t)),L.Marker.prototype.initialize.call(this,this.g[0],i)},M:function(t){if(window.NOW_MS>=this.p)return this.getIcon().options.html.classList.remove("grow"),void L.Util.requestAnimFrame(t=>{this.getIcon().options.html.classList.add("shrink"),setTimeout(()=>this.remove(),1e3)});const n=(window.NOW_MS-this.u)/this.v*this.L,r=function(t,n,r){let e=0;for(;e<t.length&&n[e]<r;)e++;if(0==e)return t[0];if(e>=t.length)return t[t.length-1];const i=n[e-1],o=(r-i)/(n[e]-i),u=t[e-1],c=t[e];return[u[0]+(c[0]-u[0])*o,u[1]+(c[1]-u[1])*o]}(this.g,this.m,n);this.setLatLng(r),this._=L.Util.requestAnimFrame(t=>this.M(t))}}),L.tripMarker=(t,n,r,e,i)=>new L.TripMarker(t,n,r,e,i),window.onload=async()=>{const t=function(){const t=L.map("map").setView([46.255,20.145],13);return L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> közreműködők | Mustoha Mátyás | Frissítve: 2020-03-18'}).addTo(t),t.setMaxBounds(t.getBounds().pad(.5)),t}(),e=new Map,o=await i();o.o=function(t,n){const r=new Map;return n.forEach((n,e)=>{const i=[0];i.length=n.length;for(let r=1;r<n.length;r++){const e=t.distance(n[r-1],n[r]);i[r]=i[r-1]+e}r.set(e,i)}),r}(t,o.shapes);const u=function(t){const n=[...t.values()].sort((t,n)=>t.start_t-n.start_t),r=[];return n.forEach(t=>{let n=r.findIndex(n=>n[n.length-1].end_t<t.start_t);n<0&&(r.push([]),n=r.length-1),r[n].push(t)}),r}(o.trips);!function(t,n){const r=new Set;n.trips.forEach(e=>{if(r.has(e.shape_id))return;const i=n.shapes.get(e.shape_id.toString()),o=n.routes.get(e.route_id).route_color;L.polyline(i,{color:o+"80"}).addTo(t),r.add(e.shape_id)})}(t,o),n(),r(e,u,t,o),document.getElementById("loading").classList.add("fade")}}();
