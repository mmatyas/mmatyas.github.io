!function(){"use strict";function t(){const n=new Date;window.NOW_MS=60*(60*n.getHours()+n.getMinutes())+n.getSeconds()+.001*n.getMilliseconds(),window.requestAnimationFrame(t)}function n(t,i,o,s){(function(t,n){return n.map(n=>n.find(n=>n.start_t<=t&&t<=n.end_t)).filter(t=>t)})(window.NOW_MS,i).filter(n=>!t.has(n.trip_id)).forEach(n=>{const i=function(t,n,i){const o=t.route_id.toString(),s=t.shape_id.toString(),e=i.routes.get(o),c=i.shapes.get(s),r=i.t.get(s),u=document.createElement("div");u.innerText=e.short_name,u.style.backgroundColor="#"+e.route_color,u.style.color="#"+e.text_color,u.classList.add("grow");const a=L.divIcon({html:u,className:"trip-icon"});return L.tripMarker(t.start_t,t.end_t,c,r,{icon:a}).bindPopup(`<b>${e.short_name}</b><br>${t.headsign}`).addTo(n)}(n,o,s);t.set(n.trip_id,i)}),setTimeout(n,1e3,t,i,o,s)}L.TripMarker=L.Marker.extend({initialize:function(t,n,i,o,s){this.i=t,this.o=n,this.s=n-t,this.u=i,this.h=o,this.p=o[o.length-1],this.L=L.Util.requestAnimFrame(t=>this.m(t)),L.Marker.prototype.initialize.call(this,this.u[0],s)},m:function(t){if(window.NOW_MS>=this.o)return this.getIcon().options.html.classList.remove("grow"),void L.Util.requestAnimFrame(t=>{this.getIcon().options.html.classList.add("shrink"),setTimeout(()=>this.remove(),1e3)});const n=(window.NOW_MS-this.i)/this.s*this.p,i=function(t,n,i){let o=0;for(;o<t.length&&n[o]<i;)o++;if(0==o)return t[0];if(o>=t.length)return t[t.length-1];const s=n[o-1],e=(i-s)/(n[o]-s),c=t[o-1],r=t[o];return[c[0]+(r[0]-c[0])*e,c[1]+(r[1]-c[1])*e]}(this.u,this.h,n);this.setLatLng(i),this.L=L.Util.requestAnimFrame(t=>this.m(t))}}),L.tripMarker=(t,n,i,o,s)=>new L.TripMarker(t,n,i,o,s),window.onload=async()=>{const i=function(){const t=L.map("map").setView([46.255,20.145],13);return L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> közreműködők | Mustoha Mátyás | Frissítve: 2020-03-18'}).addTo(t),t.setMaxBounds(t.getBounds().pad(.5)),t}(),o=new Map,s=await async function(){const t=await fetch("data.json"),n=await t.json();["routes","trips","shapes"].forEach(t=>n[t]=new Map(Object.entries(n[t])));const i=1<<(new Date).getDay();for(const[t,o]of n.trips)0==(o.flags&i)?n.trips.delete(t):o.trip_id=t;return n}();s.t=function(t,n){const i=new Map;return n.forEach((n,o)=>{const s=[0];s.length=n.length;for(let i=1;i<n.length;i++){const o=t.distance(n[i-1],n[i]);s[i]=s[i-1]+o}i.set(o,s)}),i}(i,s.shapes);const e=function(t){const n=[...t.values()].sort((t,n)=>t.start_t-n.start_t),i=[];return n.forEach(t=>{let n=i.findIndex(n=>n[n.length-1].end_t<t.start_t);n<0&&(i.push([]),n=i.length-1),i[n].push(t)}),i}(s.trips);!function(t,n){const i=new Set;n.trips.forEach(o=>{if(i.has(o.shape_id))return;const s=n.shapes.get(o.shape_id.toString()),e=n.routes.get(o.route_id.toString()).route_color;L.polyline(s,{color:"#"+e+"80"}).addTo(t),i.add(o.shape_id)})}(i,s),t(),n(o,e,i,s),document.getElementById("loading").classList.add("fade")}}();
