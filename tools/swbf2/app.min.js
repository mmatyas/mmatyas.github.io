"use strict";class t{constructor(t){this.blob=t,this.view=new DataView(this.blob),this.offset=0}t(){return this.offset}size(){return this.blob.byteLength}seek(t){this.offset=t}i(t){const n=this.blob.slice(this.offset,this.offset+t);return this.offset+=t,n}o(){const t=this.view.getUint8(this.offset);return this.offset+=1,t}h(){const t=this.view.getUint32(this.offset,!0);return this.offset+=4,t}u(t){const n=[];for(;;){const t=this.o();if(!t)break;n.push(t)}const s=new Uint8Array(n);return window.iconv.decode(s,t)}}class n{constructor(){this.l=[],this.size=0}_(t){this.l.push(t),this.size+=t.byteLength}m(t){this._(new Uint8Array([t]).buffer)}p(t){this._(new Uint32Array(t).buffer)}j(t){this.p([t])}A(t,n){const s=window.iconv.encode(t,n);this._(s),this.m(0)}U(){const t=new Uint8Array(this.size);let n=0;for(const s of this.l)t.set(new Uint8Array(s),n),n+=s.byteLength;return t.buffer}}class s{constructor(t){this.text="",this.key=t.h(),this.O=t.h()}D(t){t.p([this.key,this.O])}}class i{constructor(n,i){this.N=i,this.k=n.h();const o=n.h(),e=new t(n.i(o)),r=e.h();e.h(),e.h(),this.v=e.i(128),e.t(),this.messages=function(t,n,s){return Array.from({length:s},(s=>new t(n)))}(s,e,r),e.t();const c=o-e.t(),a=new t(e.i(c));this.messages.forEach((t=>{a.seek(t.O),t.text=a.u(this.N)}))}D(t){const s=new n;[...this.messages].sort(((t,n)=>t.O-n.O)).forEach((t=>{t.O=s.size,s.A(t.text,this.N)}));const i=s.U(),o=12+this.v.byteLength,e=o+8*this.messages.length,r=new n;r.p([this.messages.length,o,e]),r._(this.v),this.messages.forEach((t=>r.p([t.key,t.O]))),r._(i);const c=r.U();t.j(this.k),t.j(c.byteLength),t._(c)}}function o(t,n,s){const i=document.createElement("a"),o=new Blob([n],{type:s});i.href=window.URL.createObjectURL(o),i.download=t,i.click()}window.onload=()=>{const s=document.getElementById("tojson-in"),e=document.getElementById("tojson-btn"),r=document.getElementById("tojson-codepage");e.onclick=async()=>{if(!s.files||!s.files.length)return;const n=r[r.selectedIndex].value,e=s.files[0].name.replace(".dat",".json"),c=await async function(n,s){try{const o=await n.arrayBuffer(),e=new t(o),r=new i(e,s).messages.map((t=>[t.key,t.text])),c=new Map(r);return JSON.stringify(Object.fromEntries(c),null,4)}catch(t){alert("Invalid DAT file!\n"+t.message)}return null}(s.files[0],n);e&&c&&o(e,c,"application/json")};const c=document.getElementById("tobin-orig"),a=document.getElementById("tobin-json"),h=document.getElementById("tobin-codepage");document.getElementById("tobin-btn").onclick=async()=>{if(!c.files||!c.files.length)return;if(!a.files||!a.files.length)return;const s=h[h.selectedIndex].value,e=await async function(s,o,e){try{const r=await o.text(),c=JSON.parse(r),a=new Map(Object.entries(c)),h=await s.arrayBuffer(),u=new t(h),d=new i(u,e);[...d.messages].forEach((t=>{t.text=a.get(t.key.toString())??t.text}));const w=new n;return d.D(w),w.U()}catch(t){alert("Invalid DAT file!\n"+t.message)}return null}(c.files[0],a.files[0],s);e&&o("NEW_"+c.files[0].name,e,"application/octet-stream")}};
